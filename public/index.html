<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Priority Task Manager</title>
    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <!-- Socket.IO, D3, and ECharts Libraries -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- Vue and Vuetify -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.15/dist/vuetify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.15/dist/vuetify.min.css" rel="stylesheet">
    <style>
      /* Split View Layout - Account for app bar */
      .split-view-main {
        padding-top: 56px !important; /* CRITICAL: Space for fixed app bar */
        padding-left: 0 !important;
        padding-right: 0 !important;
        padding-bottom: 0 !important;
        overflow: hidden;
        height: 100vh;
      }
      
      .split-view-container {
        display: flex;
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
      }
      
      .split-view-left {
        flex: 0 0 55%;
        height: 100%;
        overflow: hidden;
        min-width: 300px;
      }
      
      .split-view-right {
        flex: 1;
        height: 100%;
        overflow-y: auto;
        padding: 16px;
        min-width: 300px;
      }
      
      .resize-handle {
        flex: 0 0 6px;
        background: rgba(0, 0, 0, 0.08);
        cursor: col-resize;
        position: relative;
        transition: background 0.2s;
      }
      
      .resize-handle:hover {
        background: rgba(25, 118, 210, 0.3);
      }
      
      .resize-handle:active {
        background: rgba(25, 118, 210, 0.5);
      }
      
      .resize-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 2px;
        height: 40px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
      }
      
      .chart-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 0 !important;
      }
      
      .chart-content {
        flex: 1;
        overflow: visible;
        padding: 0 !important;
        position: relative;
        min-height: 0; /* Allow flexbox to shrink */
      }
      
      #taskChart {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      
      /* Responsive: Stack on tablet and smaller screens */
      @media (max-width: 768px) {
        .split-view-container {
          flex-direction: column;
        }

        .split-view-left {
          flex: 0 0 auto;
          height: 45vh;
          min-height: 250px;
          max-height: 400px;
          border-right: none;
          border-bottom: 1px solid rgba(0, 0, 0, 0.12);
        }

        .split-view-right {
          flex: 1;
          padding: 12px;
          -webkit-overflow-scrolling: touch;
        }

        .resize-handle {
          display: none;
        }
      }

      /* Phone portrait - more compact chart */
      @media (max-width: 480px) {
        .split-view-left {
          height: 40vh;
          min-height: 220px;
          max-height: 320px;
        }

        .split-view-right {
          padding: 8px;
        }
      }
      
      :root {
        --golden-ratio: 1.618;
        --base-space: 8px;
        --space-1: var(--base-space); /* 8px */
        --space-2: calc(var(--base-space) * var(--golden-ratio)); /* ~13px */
        --space-3: calc(calc(var(--base-space) * var(--golden-ratio)) * var(--golden-ratio)); /* ~21px */
      }

      /* Task list improvements */
      .v-list-item {
        min-height: 64px !important;
        padding: var(--space-1) var(--space-2) !important;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      .task-item:hover {
        background-color: rgba(37, 80, 53, 0.04) !important;
      }

      .gap-golden {
        gap: var(--space-2) !important;
      }

      /* --- Simple Hierarchical Tree Structure --- */
      .subtasks-wrapper {
        margin-left: var(--space-3);
        position: relative;
        border-left: 1px solid rgba(0, 0, 0, 0.08);
      }

      /* Junction Toggle Icons */
      .toggle-junction {
        width: 44px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px; /* Tight gap for toggle group */
      }

      /* Checkbox & List Item Tweaks */
      .task-item {
        min-height: 64px !important;
        border-bottom: 1px solid #e8edea !important;
      }

      .task-metrics-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      /* Icon-only button refinements */
      .v-btn--icon.v-btn--size-small {
        width: 32px !important;
        height: 32px !important;
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        .v-list-item {
          padding: var(--space-1) var(--space-1) !important;
        }
        .task-metrics-group {
          gap: var(--space-1) !important;
        }
        .timer-display {
          display: none !important; /* Hide text timer on mobile if needed */
        }
      }

      .text-primary {
        color: #255035 !important;
      }

      .highlighted-task {
        animation: highlight-pulse 1.5s ease-in-out;
      }
      
      @keyframes highlight-pulse {
        0% { background-color: transparent; }
        50% { background-color: rgba(37, 80, 53, 0.1); }
        100% { background-color: transparent; }
      }
      
      .selected-dot {
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
      }
      
      /* Add these styles for better tooltip appearance and positioning */
      .chart-tooltip {
        font-family: 'Roboto', sans-serif;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        word-wrap: break-word;
        overflow: hidden;
      }
      
      .chart-tooltip-header {
        padding: 10px 14px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        font-weight: 500;
      }
      
      .chart-tooltip-body {
        padding: 10px 14px;
      }
      
      /* Make task dots more visible on hover */
      .task-dot:hover {
        stroke: white;
        stroke-width: 2px;
        transition: all 0.2s ease;
      }
      
      /* Selected dot style */
      .selected-dot {
        filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
      }
      
      /* Ensure the chart container has proper overflow handling */
      #taskChart {
        overflow: visible !important;
        position: relative;
      }
      
      /* Add these styles to support the cluster and line-connected tooltips */
      .task-dot.cluster-dot {
        opacity: 0.9;
        transition: all 0.3s ease;
      }
      
      .task-dot.mini-dot {
        opacity: 0.85;
        transition: none;
      }
      
      .task-dot.mini-dot:hover {
        opacity: 0.85;
        transform: none;
      }
      
      .cluster-expansion {
        animation: fade-in 0.3s ease-out;
      }
      
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* Ensure the chart container can show content outside its boundaries */
      .v-card-text {
        overflow: visible !important;
      }
      
      #taskChart {
        overflow: visible !important;
        z-index: 1;
      }
      
      /* Custom style for subtask link chips */
      .subtask-link-chip {
        cursor: pointer !important;
        transition: all 0.2s ease;
      }
      
      .subtask-link-chip:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2) !important;
        background-color: rgba(125, 125, 255, 0.1);
      }
      
      .subtask-link-chip .v-chip__content {
        color: #3f51b5 !important;
      }
      
      .subtask-link-chip .v-chip__content .v-icon {
        color: #651fff !important;
      }

      /* Analytics View Styles */
      .analytics-view {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
      }

      .v-theme--dark .analytics-view {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      }
    </style>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Add this notification container just after the body opening tag -->
    <div id="notification-container"></div>
    
    <div id="app">
        <v-app :theme="theme">
            <v-app-bar density="comfortable" elevation="2">
                <!-- Responsive title -->
                <v-app-bar-title class="text-primary">
                    <span class="d-none d-sm-inline">Priority Task Manager</span>
                    <span class="d-sm-none">Tasks</span>
                </v-app-bar-title>
                <v-spacer></v-spacer>

                <!-- User Profile / Login -->
                <div v-if="user" class="d-flex align-center" :class="$vuetify.display.xs ? 'me-1' : 'me-4'">
                    <v-avatar :size="$vuetify.display.xs ? 28 : 32" class="me-2">
                        <v-img :src="user.avatar" :alt="user.name"></v-img>
                    </v-avatar>
                    <span class="text-body-2 me-2 d-none d-md-inline">{{ user.name }}</span>
                    <v-btn icon size="small" @click="logout" title="Logout" color="primary" class="d-none d-sm-flex">
                        <v-icon>mdi-logout</v-icon>
                    </v-btn>
                </div>
                <v-btn v-else-if="authConfig.googleEnabled" color="primary" variant="elevated" prepend-icon="mdi-google" @click="loginWithGoogle" :class="$vuetify.display.xs ? 'me-1' : 'me-4'" :size="$vuetify.display.xs ? 'small' : 'default'">
                    <span class="d-none d-sm-inline">Login</span>
                    <span class="d-sm-none">Login</span>
                </v-btn>

                <!-- Mobile: Overflow menu for action buttons -->
                <v-menu v-if="$vuetify.display.xs" location="bottom end">
                    <template v-slot:activator="{ props }">
                        <v-btn icon v-bind="props" color="primary">
                            <v-icon>mdi-dots-vertical</v-icon>
                        </v-btn>
                    </template>
                    <v-list density="compact">
                        <v-list-item @click="currentView = currentView === 'tasks' ? 'analytics' : 'tasks'">
                            <template v-slot:prepend>
                                <v-icon>{{ currentView === 'tasks' ? 'mdi-chart-line' : 'mdi-arrow-left' }}</v-icon>
                            </template>
                            <v-list-item-title>{{ currentView === 'tasks' ? 'Analytics' : 'Tasks' }}</v-list-item-title>
                        </v-list-item>
                        <v-list-item @click="showCsvImportDialog = true">
                            <template v-slot:prepend>
                                <v-icon>mdi-file-import</v-icon>
                            </template>
                            <v-list-item-title>Import CSV</v-list-item-title>
                        </v-list-item>
                        <v-list-item @click="exportTasks">
                            <template v-slot:prepend>
                                <v-icon>mdi-download</v-icon>
                            </template>
                            <v-list-item-title>Export Tasks</v-list-item-title>
                        </v-list-item>
                        <v-list-item @click="toggleTheme">
                            <template v-slot:prepend>
                                <v-icon>{{ isDarkTheme ? 'mdi-weather-sunny' : 'mdi-weather-night' }}</v-icon>
                            </template>
                            <v-list-item-title>{{ isDarkTheme ? 'Light Mode' : 'Dark Mode' }}</v-list-item-title>
                        </v-list-item>
                        <v-list-item v-if="user" @click="logout">
                            <template v-slot:prepend>
                                <v-icon>mdi-logout</v-icon>
                            </template>
                            <v-list-item-title>Logout</v-list-item-title>
                        </v-list-item>
                    </v-list>
                </v-menu>

                <!-- Desktop: Show all action buttons -->
                <template v-if="!$vuetify.display.xs">
                    <v-btn icon @click="currentView = currentView === 'tasks' ? 'analytics' : 'tasks'" :title="currentView === 'tasks' ? 'View Analytics' : 'Back to Tasks'" color="primary">
                        <v-icon>{{ currentView === 'tasks' ? 'mdi-chart-line' : 'mdi-arrow-left' }}</v-icon>
                    </v-btn>
                    <v-btn icon @click="showCsvImportDialog = true" title="Import Tasks from CSV" color="primary">
                        <v-icon>mdi-file-import</v-icon>
                    </v-btn>
                    <v-btn icon @click="exportTasks" title="Export Current Tasks to CSV" color="primary">
                        <v-icon>mdi-download</v-icon>
                    </v-btn>
                    <v-btn icon @click="toggleTheme" title="Toggle Theme" color="primary">
                        <v-icon>{{ isDarkTheme ? 'mdi-weather-sunny' : 'mdi-weather-night' }}</v-icon>
                    </v-btn>
                </template>
            </v-app-bar>

            <v-main class="split-view-main">
                <!-- Analytics View (ECharts) -->
                <div v-if="currentView === 'analytics'" class="analytics-view" style="height: 100%; overflow-y: auto;" :style="$vuetify.display.xs ? 'padding: 8px;' : 'padding: 16px;'">
                    <v-container fluid :class="$vuetify.display.xs ? 'pa-0' : ''">
                        <!-- Header -->
                        <v-row class="mb-4">
                            <v-col cols="12">
                                <h1 :class="$vuetify.display.xs ? 'text-h5' : 'text-h4'" class="text-primary d-flex align-center">
                                    <v-icon class="me-2" :size="$vuetify.display.xs ? 24 : 32">mdi-chart-areaspline</v-icon>
                                    <span class="d-none d-sm-inline">Productivity Analytics</span>
                                    <span class="d-sm-none">Analytics</span>
                                </h1>
                                <p class="text-subtitle-2 text-grey mt-1 d-none d-sm-block">Track your focus time, streaks, and productivity insights</p>
                            </v-col>
                        </v-row>

                        <!-- Top Stats Row - 2 columns on mobile -->
                        <v-row class="mb-4">
                            <v-col cols="6" sm="6" md="3">
                                <v-card elevation="4" :class="$vuetify.display.xs ? 'pa-2' : 'pa-4'" class="text-center" color="primary" variant="tonal">
                                    <v-icon :size="$vuetify.display.xs ? 28 : 40" color="primary" class="mb-1">mdi-target</v-icon>
                                    <div :class="$vuetify.display.xs ? 'text-h5' : 'text-h3'" class="font-weight-bold text-primary">{{ analytics.productivityScore }}%</div>
                                    <div class="text-caption text-grey">Productivity</div>
                                    <div class="text-caption text-grey-darken-1 d-none d-sm-block">Time on high-importance tasks</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="6" md="3">
                                <v-card elevation="4" :class="$vuetify.display.xs ? 'pa-2' : 'pa-4'" class="text-center" color="success" variant="tonal">
                                    <v-icon :size="$vuetify.display.xs ? 28 : 40" color="success" class="mb-1">mdi-fire</v-icon>
                                    <div :class="$vuetify.display.xs ? 'text-h5' : 'text-h3'" class="font-weight-bold text-success">{{ analytics.currentStreak }}</div>
                                    <div class="text-caption text-grey">Day Streak</div>
                                    <div class="text-caption text-grey-darken-1 d-none d-sm-block">Consecutive focus days</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="6" md="3">
                                <v-card elevation="4" :class="$vuetify.display.xs ? 'pa-2' : 'pa-4'" class="text-center" color="info" variant="tonal">
                                    <v-icon :size="$vuetify.display.xs ? 28 : 40" color="info" class="mb-1">mdi-clock-outline</v-icon>
                                    <div :class="$vuetify.display.xs ? 'text-h5' : 'text-h3'" class="font-weight-bold text-info">{{ analytics.thisWeekHours }}h</div>
                                    <div class="text-caption text-grey">This Week</div>
                                    <v-chip
                                        :color="analytics.weekChange >= 0 ? 'success' : 'error'"
                                        size="x-small"
                                        class="mt-1 d-none d-sm-inline-flex"
                                    >
                                        <v-icon size="12" start>{{ analytics.weekChange >= 0 ? 'mdi-arrow-up' : 'mdi-arrow-down' }}</v-icon>
                                        {{ Math.abs(analytics.weekChange) }}%
                                    </v-chip>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="6" md="3">
                                <v-card elevation="4" :class="$vuetify.display.xs ? 'pa-2' : 'pa-4'" class="text-center" color="warning" variant="tonal">
                                    <v-icon :size="$vuetify.display.xs ? 28 : 40" color="warning" class="mb-1">mdi-timer</v-icon>
                                    <div :class="$vuetify.display.xs ? 'text-h5' : 'text-h3'" class="font-weight-bold text-warning">{{ analytics.totalPomodoros }}</div>
                                    <div class="text-caption text-grey">Pomodoros</div>
                                    <div class="text-caption text-grey-darken-1 d-none d-sm-block">25+ min sessions</div>
                                </v-card>
                            </v-col>
                        </v-row>

                        <!-- Secondary Stats -->
                        <v-row class="mb-4">
                            <v-col cols="6" sm="4" md="2">
                                <v-card elevation="2" class="pa-3 text-center">
                                    <div class="text-h5 font-weight-bold">{{ analytics.totalHours }}h</div>
                                    <div class="text-caption text-grey">Total Focus</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="4" md="2">
                                <v-card elevation="2" class="pa-3 text-center">
                                    <div class="text-h5 font-weight-bold">{{ analytics.totalSessions }}</div>
                                    <div class="text-caption text-grey">Sessions</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="4" md="2">
                                <v-card elevation="2" class="pa-3 text-center">
                                    <div class="text-h5 font-weight-bold">{{ analytics.avgSessionMins }}m</div>
                                    <div class="text-caption text-grey">Avg Session</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="4" md="2">
                                <v-card elevation="2" class="pa-3 text-center">
                                    <div class="text-h5 font-weight-bold">{{ analytics.tasksCompleted }}</div>
                                    <div class="text-caption text-grey">Completed</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="4" md="2">
                                <v-card elevation="2" class="pa-3 text-center">
                                    <div class="text-h5 font-weight-bold">{{ analytics.tasksActive }}</div>
                                    <div class="text-caption text-grey">Active</div>
                                </v-card>
                            </v-col>
                            <v-col cols="6" sm="4" md="2">
                                <v-card elevation="2" class="pa-3 text-center">
                                    <div class="text-h5 font-weight-bold">{{ analytics.completionRate }}%</div>
                                    <div class="text-caption text-grey">Completion</div>
                                </v-card>
                            </v-col>
                        </v-row>

                        <!-- Charts Row 1 -->
                        <v-row class="mb-4">
                            <v-col cols="12" md="8">
                                <v-card elevation="3">
                                    <v-card-title class="d-flex align-center">
                                        <v-icon class="me-2" color="primary">mdi-chart-timeline-variant</v-icon>
                                        Daily Focus Time (Last 30 Days)
                                    </v-card-title>
                                    <v-card-text>
                                        <div id="dailyFocusChart" style="height: 300px;"></div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                            <v-col cols="12" md="4">
                                <v-card elevation="3">
                                    <v-card-title class="d-flex align-center">
                                        <v-icon class="me-2" color="success">mdi-chart-donut</v-icon>
                                        Session Distribution
                                    </v-card-title>
                                    <v-card-text>
                                        <div id="sessionDistChart" style="height: 300px;"></div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>

                        <!-- Charts Row 2 -->
                        <v-row class="mb-4">
                            <v-col cols="12" md="6">
                                <v-card elevation="3">
                                    <v-card-title class="d-flex align-center">
                                        <v-icon class="me-2" color="info">mdi-clock-time-eight</v-icon>
                                        Focus by Hour of Day
                                    </v-card-title>
                                    <v-card-text>
                                        <div id="hourlyChart" style="height: 280px;"></div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-card elevation="3">
                                    <v-card-title class="d-flex align-center">
                                        <v-icon class="me-2" color="warning">mdi-timer-outline</v-icon>
                                        Pomodoros Over Time
                                    </v-card-title>
                                    <v-card-text>
                                        <div id="pomodoroChart" style="height: 280px;"></div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>

                        <!-- Charts Row 3 -->
                        <v-row>
                            <v-col cols="12">
                                <v-card elevation="3">
                                    <v-card-title class="d-flex align-center">
                                        <v-icon class="me-2" color="primary">mdi-format-list-numbered</v-icon>
                                        Top Tasks by Time Spent
                                    </v-card-title>
                                    <v-card-text>
                                        <div id="topTasksChart" style="height: 300px;"></div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>
                    </v-container>
                </div>

                <!-- Split View Container (Tasks View) -->
                <div v-show="currentView === 'tasks'" class="split-view-container" ref="splitContainer">
                    <!-- LEFT SIDE: Chart (always full height) -->
                    <div class="split-view-left" ref="leftPanel" :style="{ flex: `0 0 ${leftPanelWidth}%` }">
                        <v-card class="chart-card" elevation="3">
                            <v-card-title class="text-h6 d-flex align-center pa-3">
                                <v-icon class="me-2" color="primary">mdi-chart-scatter-plot</v-icon>
                                {{ isQ1ZoomMode ? 'Q1 Zoom: Priorities' : 'Eisenhower Matrix' }}
                                <v-spacer></v-spacer>
                                <v-btn
                                    icon="mdi-plus"
                                    variant="text"
                                    size="small"
                                    @click="zoomIn"
                                    color="primary"
                                    title="Zoom In"
                                    class="me-1"
                                ></v-btn>
                                <v-btn
                                    icon="mdi-minus"
                                    variant="text"
                                    size="small"
                                    @click="zoomOut"
                                    color="primary"
                                    title="Zoom Out"
                                    class="me-1"
                                ></v-btn>
                                <v-btn
                                    v-if="isChartZoomed"
                                    icon="mdi-restore"
                                    variant="text"
                                    size="small"
                                    @click="toggleQ1ZoomMode"
                                    color="error"
                                    title="Reset Zoom"
                                    class="me-1"
                                ></v-btn>
                                <v-btn
                                    v-else
                                    icon="mdi-magnify-plus"
                                    variant="text"
                                    size="small"
                                    @click="toggleQ1ZoomMode"
                                    color="primary"
                                    title="Zoom Q1 (Important & Urgent)"
                                    class="me-1"
                                ></v-btn>
                                <v-btn
                                    icon="mdi-chart-network"
                                    variant="text"
                                    size="small"
                                    @click="toggleRelationships"
                                    :color="showRelationships ? 'purple' : 'primary'"
                                    :title="showRelationships ? 'Hide Task Relationships' : 'Show Task Relationships'"
                                    class="me-1"
                                ></v-btn>
                                <v-btn
                                    icon="mdi-sitemap"
                                    variant="text"
                                    size="small"
                                    @click="toggleChartSubtasks"
                                    :color="showChartSubtasks ? 'purple' : 'primary'"
                                    :title="showChartSubtasks ? 'Hide Subtasks on Chart' : 'Show Subtasks on Chart'"
                                    class="me-2"
                                ></v-btn>
                                <v-chip :color="isQ1ZoomMode ? 'error' : 'primary'" size="small">{{ activeTasks.length }}</v-chip>
                            </v-card-title>
                            <v-card-text class="chart-content">
                                <div id="taskChart" :style="chartStyle"></div>
                            </v-card-text>
                        </v-card>
                    </div>

                    <!-- RESIZE HANDLE -->
                    <div 
                        class="resize-handle" 
                        @mousedown="startResize"
                        title="Drag to resize"
                    ></div>

                    <!-- RIGHT SIDE: Task List (scrollable) -->
                    <div class="split-view-right" ref="rightPanel">

                        <!-- Active Tasks Section -->
                        <v-card class="mb-4" elevation="3">
                        <v-card-title 
                            class="text-h5 d-flex align-center"
                            @dragover.prevent="handleDragOver"
                            @drop="handleDropOnRoot"
                            style="cursor: default;"
                            title="Drop tasks here to make them root tasks"
                        >
                            Active Tasks
                            <v-spacer></v-spacer>
                            <v-chip color="primary" size="small" class="me-2">{{ activeTasks.length }}</v-chip>
                            <v-btn 
                                variant="text" 
                                icon 
                                @click="toggleInfluenceMode"
                                class="ms-2"
                                :color="influenceMode ? 'purple' : 'primary'"
                                :title="influenceMode ? 'Switch to Importance Mode' : 'Switch to Influence Mode'"
                            >
                                <v-icon>
                                    {{ influenceMode ? 'mdi-arrow-up-bold-circle' : 'mdi-star-circle' }}
                                </v-icon>
                            </v-btn>
                            <v-btn 
                                variant="text" 
                                icon 
                                @click="toggleCompletedSubtasks"
                                class="ms-2"
                                title="Toggle completed subtasks"
                                color="primary"
                            >
                                <v-icon>
                                    {{ showCompletedSubtasks ? 'mdi-eye-off' : 'mdi-eye' }}
                                </v-icon>
                            </v-btn>
                            <v-btn 
                                variant="text" 
                                icon 
                                @click="toggleNotSureTasks"
                                class="ms-2"
                                :color="showNotSureTasks ? 'warning' : 'primary'"
                                title="Toggle 'Not Sure' tasks"
                            >
                                <v-icon>
                                    {{ showNotSureTasks ? 'mdi-help-circle' : 'mdi-help-circle-outline' }}
                                </v-icon>
                            </v-btn>
                        </v-card-title>
                        <v-card-text>
                            <!-- Sort Dropdown -->
                            <div class="mb-2 px-2">
                                <v-select
                                    v-model="taskSortBy"
                                    :items="taskSortOptions"
                                    label="Sort by"
                                    variant="underlined"
                                    density="compact"
                                    prepend-inner-icon="mdi-sort"
                                    hide-details
                                    class="minimal-select"
                                ></v-select>
                            </div>
                            
                            <v-list v-if="activeTasks.length > 0">
                                <task-node
                                    v-for="task in sortedActiveTasks"
                                    :key="task.id"
                                    :task="task"
                                    :depth="0"
                                    :tasks="tasks"
                                    :expanded-tasks="expandedTasks"
                                    :show-completed-subtasks="showCompletedSubtasks"
                                ></task-node>
                            </v-list>
                            
                            <v-sheet v-else class="pa-4 text-center">
                                <v-icon size="large" color="grey">mdi-playlist-check</v-icon>
                                <div class="text-body-1 mt-2">No active tasks. Add a task to get started!</div>
                            </v-sheet>
                            
                            <!-- Empty drop area -->
                            <v-sheet
                                id="empty-drop-area"
                                ref="emptyDropArea"
                                class="mt-4 pa-6 text-center bg-grey-lighten-4 rounded"
                                border
                                @dragover="handleDragOver"
                                @dragleave="handleDragLeave"
                                @drop="handleDropOnRoot"
                                :class="{ 'drag-over': draggedTask }"
                            >
                                <v-icon color="grey" class="mb-2">mdi-drag</v-icon>
                                <div class="text-body-2 text-grey">Drop tasks here to move to root level</div>
                            </v-sheet>
                        </v-card-text>
                    </v-card>

                        <!-- Completed Tasks Section -->
                        <v-card v-if="hasCompletedTasks" class="mb-4" elevation="3">
                        <v-card-title 
                            class="text-h5 d-flex align-center" 
                            @click="toggleTaskSection('completed')"
                            style="cursor: pointer;"
                        >
                            <v-icon color="success" class="me-2">mdi-check-circle</v-icon>
                            Completed Tasks
                            <v-spacer></v-spacer>
                            <v-chip color="success" size="small">{{ completedTasks.length }}</v-chip>
                            <v-icon>{{ taskSectionOpen.completed ? 'mdi-chevron-up' : 'mdi-chevron-down' }}</v-icon>
                        </v-card-title>
                        
                        <v-expand-transition>
                            <div v-show="taskSectionOpen.completed">
                                <v-list>
                            <template v-for="task in completedTasks" :key="task.id">
                                        <!-- Completed Parent Task -->
                                        <v-list-item
                                            :value="task.id"
                                            @click="selectTask(task)"
                                            @dblclick="showAddSubtaskForm(task.id)"
                                    :data-task-id="task.id"
                                            style="cursor: pointer;" 
                                            class="task completed-task"
                                        >
                                            <template v-slot:prepend>
                                                <v-checkbox 
                                                    :model-value="true" 
                                                    @change="toggleTaskDone(task)"
                                                    color="success"
                                                    hide-details
                                                    @click.stop
                                                ></v-checkbox>
                                            </template>

                                            <v-list-item-title class="text-decoration-line-through">
                                                {{ task.name }}
                                            </v-list-item-title>

                                            <v-list-item-subtitle>
                                                <div class="d-flex align-center">
                                                    <span class="text-caption text-medium-emphasis me-2" v-if="task.completed_at">
                                                        Completed: {{ formatDate(task.completed_at) }}
                                                    </span>
                                                    <v-btn
                                                        v-if="task.link"
                                                        size="x-small"
                                                        :href="task.link" 
                                                        target="_blank"
                                                        color="primary"
                                                        variant="text"
                                                        class="px-0 min-width-0 me-2"
                                                        @click.stop
                                                    >
                                                        <v-icon start size="x-small">mdi-link</v-icon>
                                                        Link
                                                    </v-btn>
                                                </div>
                                            </v-list-item-subtitle>

                                            <template v-slot:append>
                                                <v-btn
                                                    icon="mdi-delete"
                                                    variant="text"
                                                    size="small"
                                                    @click.stop="deleteTask(task.id, task.name)"
                                                    color="error"
                                                    title="Delete task"
                                                ></v-btn>
                                            </template>
                                        </v-list-item>
                                        
                                        <v-divider></v-divider>
                                    </template>
                                </v-list>
                                            </div>
                        </v-expand-transition>
                        </v-card>
                    </div>
                    <!-- End Right Side -->
                </div>
                <!-- End Split View Container -->
            </v-main>

            <!-- Subtask Modal Dialog -->
            <v-dialog v-model="showSubtaskModal" :fullscreen="$vuetify.display.xs" :max-width="$vuetify.display.xs ? undefined : '500px'" scrollable>
                <v-card :rounded="$vuetify.display.xs ? 0 : 'lg'">
                    <!-- Mobile toolbar -->
                    <v-toolbar v-if="$vuetify.display.xs" color="primary" density="compact">
                        <v-btn icon @click="closeSubtaskModal"><v-icon>mdi-close</v-icon></v-btn>
                        <v-toolbar-title>Add Subtask</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn variant="text" @click="addSubtask">Add</v-btn>
                    </v-toolbar>
                    <v-card-title v-else class="text-h5">Add Subtask</v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="addSubtask">
                            <v-text-field
                                v-model="newSubtask.name"
                                label="Subtask Name"
                                required
                                variant="outlined"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ newSubtask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="newSubtask.icon = icon"
                                                    :color="newSubtask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>
                            
                            <v-text-field
                                v-model="newSubtask.link"
                                label="Link (optional)"
                                variant="outlined"
                                placeholder="Add a URL (http://example.com)"
                            ></v-text-field>
                            
                            <div class="d-flex align-center justify-space-between mb-1">
                                <span class="text-subtitle-2">Importance: {{ Number(newSubtask.importance).toFixed(1) }}</span>
                            </div>
                            <v-slider
                                v-model="newSubtask.importance"
                                min="1"
                                max="10"
                                step="0.1"
                                color="primary"
                                thumb-label
                                hide-details
                                class="mb-4"
                            ></v-slider>
                            
                            <div class="d-flex align-center justify-space-between mb-1">
                                <span class="text-subtitle-2">Urgency: {{ Number(newSubtask.urgency).toFixed(1) }}</span>
                            </div>
                            <v-slider
                                v-model="newSubtask.urgency"
                                min="1"
                                max="10"
                                step="0.1"
                                color="secondary"
                                thumb-label
                                hide-details
                                class="mb-4"
                            ></v-slider>
                            
                            <v-date-picker
                                v-model="newSubtask.due_date"
                                label="Due Date (Optional)"
                                variant="outlined"
                            ></v-date-picker>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="closeSubtaskModal">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="addSubtask">Add Subtask</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Edit Subtask Dialog -->
            <v-dialog v-model="showEditForm" :fullscreen="$vuetify.display.xs" :max-width="$vuetify.display.xs ? undefined : '600px'" scrollable>
                <v-card :rounded="$vuetify.display.xs ? 0 : 'lg'">
                    <!-- Mobile toolbar -->
                    <v-toolbar v-if="$vuetify.display.xs" color="primary" density="compact">
                        <v-btn icon @click="cancelEdit"><v-icon>mdi-close</v-icon></v-btn>
                        <v-toolbar-title>Edit Subtask</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn variant="text" @click="saveSubtaskEdit">Save</v-btn>
                    </v-toolbar>
                    <v-card-title v-else class="text-h5">Edit Subtask</v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="saveSubtaskEdit">
                            <v-text-field
                                v-model="editingSubtask.name"
                                label="Subtask Name"
                                required
                                variant="outlined"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ editingSubtask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="editingSubtask.icon = icon"
                                                    :color="editingSubtask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>

                            <v-text-field
                                v-model="editingSubtask.link"
                                label="Link (optional)"
                                variant="outlined"
                                placeholder="Add a URL (http://example.com)"
                                class="mb-3"
                            ></v-text-field>

                            <div class="d-flex align-center justify-space-between mb-1 mt-2">
                                <span class="text-subtitle-2">Importance: {{ Number(editingSubtask.importance).toFixed(1) }}</span>
                                <v-chip :color="getPriorityColor(editingSubtask.importance)" size="x-small" variant="flat">
                                    {{ editingSubtask.importance >= 8 ? 'CRITICAL' : (editingSubtask.importance >= 5 ? 'HIGH' : 'LOW') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingSubtask.importance"
                                min="1"
                                max="10"
                                step="0.1"
                                :color="getPriorityColor(editingSubtask.importance)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-star-outline</v-icon>
                                </template>
                                <template v-slot:append>
                                    <v-icon size="small" :color="getPriorityColor(editingSubtask.importance)">mdi-star</v-icon>
                                </template>
                            </v-slider>

                            <div class="d-flex align-center justify-space-between mb-1">
                                <span class="text-subtitle-2">Urgency: {{ Number(editingSubtask.urgency).toFixed(1) }}</span>
                                <v-chip :color="getPriorityColor(editingSubtask.urgency)" size="x-small" variant="flat">
                                    {{ editingSubtask.urgency >= 8 ? 'IMMEDIATE' : (editingSubtask.urgency >= 5 ? 'SOON' : 'LATER') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingSubtask.urgency"
                                min="1"
                                max="10"
                                step="0.1"
                                :color="getPriorityColor(editingSubtask.urgency)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-clock-outline</v-icon>
                                </template>
                                <template v-slot:append>
                                    <v-icon size="small" :color="getPriorityColor(editingSubtask.urgency)">mdi-clock-fast</v-icon>
                                </template>
                            </v-slider>

                            <v-select
                                v-model="editingSubtask.parent_id"
                                :items="possibleParents"
                                item-title="name"
                                item-value="id"
                                label="Parent Task"
                                variant="outlined"
                                class="mb-3"
                            ></v-select>

                            <v-date-picker
                                v-model="editingSubtask.due_date"
                                label="Due Date (Optional)"
                                variant="outlined"
                            ></v-date-picker>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="cancelEdit">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="saveSubtaskEdit">Save</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Edit Task Dialog -->
            <v-dialog v-model="showTaskEditForm" :fullscreen="$vuetify.display.xs" :max-width="$vuetify.display.xs ? undefined : '600px'" scrollable>
                <v-card :rounded="$vuetify.display.xs ? 0 : 'lg'">
                    <!-- Mobile toolbar -->
                    <v-toolbar v-if="$vuetify.display.xs" color="primary" density="compact">
                        <v-btn icon @click="cancelTaskEdit"><v-icon>mdi-close</v-icon></v-btn>
                        <v-toolbar-title>Edit Task</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn variant="text" @click="saveTaskEdit">Save</v-btn>
                    </v-toolbar>
                    <v-card-title v-else class="text-h5">Edit Task</v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="saveTaskEdit">
                            <v-text-field
                                v-model="editingTask.name"
                                label="Task Name"
                                required
                                variant="outlined"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ editingTask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="editingTask.icon = icon"
                                                    :color="editingTask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>

                            <v-text-field
                                v-model="editingTask.link"
                                label="Link (optional)"
                                variant="outlined"
                                placeholder="Add a URL (http://example.com)"
                                class="mb-3"
                            ></v-text-field>

                            <div class="d-flex align-center justify-space-between mb-1 mt-2">
                                <span class="text-subtitle-2">Importance: {{ Number(editingTask.importance).toFixed(1) }}</span>
                                <v-chip :color="getPriorityColor(editingTask.importance)" size="x-small" variant="flat">
                                    {{ editingTask.importance >= 8 ? 'CRITICAL' : (editingTask.importance >= 5 ? 'HIGH' : 'LOW') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingTask.importance"
                                min="1"
                                max="10"
                                step="0.1"
                                :color="getPriorityColor(editingTask.importance)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-star-outline</v-icon>
                                </template>
                                <template v-slot:append>
                                    <v-icon size="small" :color="getPriorityColor(editingTask.importance)">mdi-star</v-icon>
                                </template>
                            </v-slider>

                            <div class="d-flex align-center justify-space-between mb-1">
                                <span class="text-subtitle-2">Urgency: {{ Number(editingTask.urgency).toFixed(1) }}</span>
                                <v-chip :color="getPriorityColor(editingTask.urgency)" size="x-small" variant="flat">
                                    {{ editingTask.urgency >= 8 ? 'IMMEDIATE' : (editingTask.urgency >= 5 ? 'SOON' : 'LATER') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingTask.urgency"
                                min="1"
                                max="10"
                                step="0.1"
                                :color="getPriorityColor(editingTask.urgency)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-clock-outline</v-icon>
                                </template>
                                <template v-slot:append>
                                    <v-icon size="small" :color="getPriorityColor(editingTask.urgency)">mdi-clock-fast</v-icon>
                                </template>
                            </v-slider>

                            <v-autocomplete
                                v-model="editingTask.enables"
                                :items="activeTasksForEditing"
                                item-title="name"
                                item-value="id"
                                label="What tasks does this make easier?"
                                multiple
                                chips
                                closable-chips
                                variant="outlined"
                                hint="Select tasks that become easier when this is done"
                                persistent-hint
                                prepend-inner-icon="mdi-arrow-right-bold"
                                class="mb-3"
                            >
                                <template v-slot:chip="{ props, item }">
                                    <v-chip
                                        v-bind="props"
                                        color="purple"
                                        variant="flat"
                                        size="small"
                                    >
                                        <v-icon start size="small">mdi-arrow-right-bold</v-icon>
                                        {{ item.raw.name }}
                                    </v-chip>
                                </template>
                                <template v-slot:item="{ props, item }">
                                    <v-list-item v-bind="props" :title="item.raw.name">
                                        <template v-slot:prepend>
                                            <v-icon color="purple" size="small">mdi-checkbox-blank-circle-outline</v-icon>
                                        </template>
                                        <template v-slot:subtitle>
                                            <span class="text-caption">
                                                Importance: {{ Number(item.raw.importance).toFixed(1) }} | Urgency: {{ Number(item.raw.urgency).toFixed(1) }}
                                            </span>
                                        </template>
                                    </v-list-item>
                                </template>
                            </v-autocomplete>

                            <v-date-picker
                                v-model="editingTask.due_date"
                                label="Due Date (Optional)"
                                variant="outlined"
                            ></v-date-picker>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="cancelTaskEdit">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="saveTaskEdit">Save</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Notes Dialog -->
            <v-dialog v-model="showNotesDialog" :fullscreen="$vuetify.display.xs" :max-width="$vuetify.display.xs ? undefined : '600px'" persistent scrollable>
                <v-card v-if="currentTask" :style="$vuetify.display.xs ? '' : 'min-height: 400px'" :rounded="$vuetify.display.xs ? 0 : 'lg'">
                    <!-- Mobile toolbar -->
                    <v-toolbar v-if="$vuetify.display.xs" color="primary" density="compact">
                        <v-btn icon @click="closeNotesDialog"><v-icon>mdi-close</v-icon></v-btn>
                        <v-toolbar-title>{{ currentTask.notes ? 'Edit Notes' : 'Add Notes' }}</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn variant="text" @click="saveTaskNotes">Save</v-btn>
                    </v-toolbar>
                    <v-card-title v-else class="text-h5 bg-primary text-white">
                        {{ currentTask.notes ? 'Edit Notes: ' : 'Add Notes: ' }} {{ currentTask.name }}
                    </v-card-title>
                    <v-card-text class="pa-4">
                        <!-- Stable key for proper Vue reactivity -->
                        <v-textarea
                            :key="`notes-${noteTaskId}`"
                            v-model="editingNotes"
                            label="Task Notes"
                            variant="outlined"
                            rows="8"
                            counter
                            auto-grow
                            placeholder="Add your notes here..."
                        ></v-textarea>
                        
                        <!-- Add a debug display to see what's happening -->
                        <div v-if="currentTask" class="mt-3 text-caption">
                            Task ID: {{ currentTask.id }} <br>
                            Note Length: {{ editingNotes ? editingNotes.length : 0 }} characters
                        </div>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="closeNotesDialog">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="saveTaskNotes">
                            Save Notes
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- CSV Import Dialog -->
            <v-dialog v-model="showCsvImportDialog" :fullscreen="$vuetify.display.xs" :max-width="$vuetify.display.xs ? undefined : '600px'" scrollable>
                <v-card :rounded="$vuetify.display.xs ? 0 : 'lg'">
                    <!-- Mobile toolbar -->
                    <v-toolbar v-if="$vuetify.display.xs" color="primary" density="compact">
                        <v-btn icon @click="showCsvImportDialog = false"><v-icon>mdi-close</v-icon></v-btn>
                        <v-toolbar-title>Import CSV</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn variant="text" @click="importCSV" :disabled="!csvFile">Import</v-btn>
                    </v-toolbar>
                    <v-card-title v-else class="text-h5 d-flex align-center">
                        <v-icon class="me-2" color="success">mdi-file-import</v-icon>
                        Import Tasks from CSV
                    </v-card-title>
                    <v-card-text>
                        <v-file-input
                            v-model="csvFile"
                            label="Select CSV file"
                            accept=".csv"
                            prepend-icon="mdi-file-delimited"
                            variant="outlined"
                            clearable
                            class="mb-3"
                        ></v-file-input>
                        
                        <!-- Import Results -->
                        <v-alert
                            v-if="csvImportResult"
                            :type="csvImportResult.success ? 'success' : 'error'"
                            closable
                            @click:close="csvImportResult = null"
                        >
                            <div v-if="csvImportResult.success">
                                Successfully imported {{ csvImportResult.details.imported }} tasks
                                <span v-if="csvImportResult.details.errors && csvImportResult.details.errors.length > 0">
                                    ({{ csvImportResult.details.errors.length }} errors)
                                </span>
                            </div>
                            <div v-else>
                                Failed to import CSV: {{ csvImportResult.error }}
                            </div>
                            
                            <div v-if="csvImportResult.details && csvImportResult.details.errors && csvImportResult.details.errors.length > 0" class="mt-2">
                                <strong>Errors:</strong>
                                <ul class="ml-4">
                                    <li v-for="error in csvImportResult.details.errors" :key="error.row">
                                        Row {{ error.row }}: {{ error.error }}
                                    </li>
                                </ul>
                            </div>
                        </v-alert>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn
                            color="grey"
                            variant="text"
                            @click="showCsvImportDialog = false"
                        >
                            Cancel
                        </v-btn>
                        <v-btn
                            color="success"
                            variant="elevated"
                            @click="importCSV"
                            :loading="csvImporting"
                            :disabled="!csvFile || csvImporting"
                        >
                            <v-icon start>mdi-upload</v-icon>
                            Import CSV
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Quick Add Task Modal -->
            <v-dialog v-model="showQuickAddModal" :fullscreen="$vuetify.display.xs" :max-width="$vuetify.display.xs ? undefined : '600px'" scrollable>
                <v-card :rounded="$vuetify.display.xs ? 0 : 'lg'">
                    <!-- Mobile toolbar -->
                    <v-toolbar v-if="$vuetify.display.xs" color="primary" density="compact">
                        <v-btn icon @click="closeQuickAddModal"><v-icon>mdi-close</v-icon></v-btn>
                        <v-toolbar-title>Quick Add Task</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-btn variant="text" @click="submitQuickTask">Add</v-btn>
                    </v-toolbar>
                    <v-card-title v-else class="text-h5 d-flex align-center">
                        <v-icon class="me-2" color="primary">mdi-plus-circle-outline</v-icon>
                        Quick Add Task
                    </v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="submitQuickTask">
                            <v-text-field
                                v-model="quickAddTask.name"
                                label="Task Name *"
                                placeholder="Enter task name..."
                                variant="outlined"
                                required
                                autofocus
                                class="mb-3"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ quickAddTask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="quickAddTask.icon = icon"
                                                    :color="quickAddTask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>

                            <v-row class="mb-3">
                                <v-col cols="12">
                                    <div class="d-flex align-center justify-space-between mb-1">
                                        <span class="text-subtitle-2">Importance: {{ isQ1ZoomMode ? quickAddTask.importance.toFixed(1) : quickAddTask.importance }}</span>
                                        <v-chip :color="getPriorityColor(quickAddTask.importance)" size="x-small" variant="flat">
                                            {{ quickAddTask.importance >= 8 ? 'CRITICAL' : (quickAddTask.importance >= 5 ? 'HIGH' : 'LOW') }}
                                        </v-chip>
                                    </div>
                                    <v-slider
                                        v-model="quickAddTask.importance"
                                        :min="isQ1ZoomMode ? 5 : 1"
                                        :max="10"
                                        :step="isQ1ZoomMode ? 0.1 : 1"
                                        :color="getPriorityColor(quickAddTask.importance)"
                                        track-color="grey-lighten-3"
                                        hide-details
                                    >
                                        <template v-slot:prepend>
                                            <v-icon size="small" color="grey">mdi-star-outline</v-icon>
                                        </template>
                                        <template v-slot:append>
                                            <v-icon size="small" :color="getPriorityColor(quickAddTask.importance)">mdi-star</v-icon>
                                        </template>
                                    </v-slider>
                                </v-col>

                                <v-col cols="12" class="mt-2">
                                    <div class="d-flex align-center justify-space-between mb-1">
                                        <span class="text-subtitle-2">Urgency: {{ isQ1ZoomMode ? quickAddTask.urgency.toFixed(1) : quickAddTask.urgency }}</span>
                                        <v-chip :color="getPriorityColor(quickAddTask.urgency)" size="x-small" variant="flat">
                                            {{ quickAddTask.urgency >= 8 ? 'IMMEDIATE' : (quickAddTask.urgency >= 5 ? 'SOON' : 'LATER') }}
                                        </v-chip>
                                    </div>
                                    <v-slider
                                        v-model="quickAddTask.urgency"
                                        :min="isQ1ZoomMode ? 5 : 1"
                                        :max="10"
                                        :step="isQ1ZoomMode ? 0.1 : 1"
                                        :color="getPriorityColor(quickAddTask.urgency)"
                                        track-color="grey-lighten-3"
                                        hide-details
                                    >
                                        <template v-slot:prepend>
                                            <v-icon size="small" color="grey">mdi-clock-outline</v-icon>
                                        </template>
                                        <template v-slot:append>
                                            <v-icon size="small" :color="getPriorityColor(quickAddTask.urgency)">mdi-clock-fast</v-icon>
                                        </template>
                                    </v-slider>
                                </v-col>
                            </v-row>

                            <v-text-field
                                v-model="quickAddTask.link"
                                label="Link (optional)"
                                placeholder="https://..."
                                variant="outlined"
                                class="mb-3"
                            ></v-text-field>

                            <v-textarea
                                v-model="quickAddTask.notes"
                                label="Notes (optional)"
                                placeholder="Additional details..."
                                variant="outlined"
                                rows="3"
                                class="mb-3"
                            ></v-textarea>

                            <v-autocomplete
                                v-model="quickAddTask.enables"
                                :items="activeTasksForLinking"
                                item-title="name"
                                item-value="id"
                                label="What tasks does this make easier?"
                                multiple
                                chips
                                closable-chips
                                variant="outlined"
                                hint="Select tasks that become easier when this is done"
                                persistent-hint
                                prepend-inner-icon="mdi-arrow-right-bold"
                            >
                                <template v-slot:chip="{ props, item }">
                                    <v-chip
                                        v-bind="props"
                                        color="purple"
                                        variant="flat"
                                        size="small"
                                    >
                                        <v-icon start size="small">mdi-arrow-right-bold</v-icon>
                                        {{ item.raw.name }}
                                    </v-chip>
                                </template>
                                <template v-slot:item="{ props, item }">
                                    <v-list-item v-bind="props" :title="item.raw.name">
                                        <template v-slot:prepend>
                                            <v-icon color="purple" size="small">mdi-checkbox-blank-circle-outline</v-icon>
                                        </template>
                                        <template v-slot:subtitle>
                                            <span class="text-caption">
                                                Importance: {{ item.raw.importance }} | Urgency: {{ item.raw.urgency }}
                                            </span>
                                        </template>
                                    </v-list-item>
                                </template>
                            </v-autocomplete>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn
                            color="grey"
                            variant="text"
                            @click="closeQuickAddModal"
                        >
                            Cancel
                        </v-btn>
                        <v-btn
                            color="primary"
                            variant="elevated"
                            @click="submitQuickTask"
                        >
                            Add Task
                            <v-icon end>mdi-check</v-icon>
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Pomodoro Break Dialog -->
            <v-dialog v-model="showBreakDialog" :max-width="$vuetify.display.xs ? '95%' : '500px'" persistent>
                <v-card rounded="lg">
                    <v-card-title class="text-h5 bg-success text-white">
                         Pomodoro Complete!
                    </v-card-title>
                    <v-card-text class="pt-6">
                        <div class="text-center mb-4">
                            <v-icon size="64" color="success">mdi-check-circle</v-icon>
                        </div>
                        <p class="text-h6 text-center mb-4">
                            Great job! You completed a 25-minute focus session.
                        </p>
                        <p class="text-center mb-2" v-if="breakTask">
                            <strong>Task:</strong> {{ breakTask.name }}
                        </p>
                        <p class="text-center mb-4" v-if="breakTask">
                            <v-chip color="primary" variant="flat">
                                 {{ breakTask.pomodoro_count }} Pomodoros completed
                            </v-chip>
                        </p>
                        <v-divider class="my-4"></v-divider>
                        <p class="text-center text-h6 mb-2">
                            Time for a {{ breakType === 'long' ? '15' : '5' }}-minute break!
                        </p>
                        <p class="text-center text-body-2 text-grey">
                            {{ breakType === 'long' ? ' Long break - You earned it!' : ' Short break - Rest and recharge' }}
                        </p>
                    </v-card-text>
                    <v-card-actions class="px-6 pb-4">
                        <v-btn text @click="skipBreak" color="grey">
                            Skip Break
                        </v-btn>
                        <v-spacer></v-spacer>
                        <v-btn color="success" variant="flat" size="large" @click="startBreak">
                            <v-icon start>mdi-coffee</v-icon>
                            Start {{ breakType === 'long' ? '15' : '5' }}-Min Break
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Break Timer Indicator (when break is active) -->
            <v-snackbar
                :model-value="breakTimeRemaining > 0"
                :timeout="-1"
                location="top"
                color="info"
            >
                <div class="d-flex align-center">
                    <v-icon start>mdi-coffee</v-icon>
                    <span class="text-h6 mr-2">Break Time:</span>
                    <span class="text-h5 font-weight-bold">{{ formatTime(breakTimeRemaining) }}</span>
                    <v-spacer></v-spacer>
                    <v-btn icon size="small" @click="endBreak">
                        <v-icon>mdi-close</v-icon>
                    </v-btn>
                </div>
            </v-snackbar>

            <!-- Snackbar for notifications -->
            <v-snackbar
                v-model="snackbar.show"
                :color="snackbar.color"
                :timeout="snackbar.timeout"
            >
                {{ snackbar.text }}
                <template v-slot:actions>
                    <v-btn
                        color="white"
                        icon="mdi-close"
                        variant="text"
                        @click="snackbar.show = false"
                    ></v-btn>
                </template>
            </v-snackbar>
        </v-app>
    </div>

    <!-- Updated Scripts -->
    <script src="modules/chartVisualization.js" type="module"></script>
    <script src="app.js" type="module"></script>

    <!-- Add this right after your body tag -->
    <script>
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded - Vuetify version:', typeof Vuetify);
      
      // Add listener to track app initialization
      window.addEventListener('app-initialized', function(e) {
        console.log('App initialized with tasks:', e.detail.taskCount);
      });
      
      // Debug socket events
      document.addEventListener('socket-event', function(e) {
        console.log('Socket event:', e.detail.event, 'with data:', e.detail.data);
      });
    });
    </script>

    <!-- Replace with this Vue 3 compatible version -->
    <script>
    window.addEventListener('app-mounted', function() {
      // Wait for app to be available in the window object
      if (window.app && typeof window.app.updateTasks === 'function') {
        const originalUpdateTasks = window.app.updateTasks;
        
        window.app.updateTasks = function(tasks) {
          console.log('updateTasks called with:', tasks?.length || 0, 'tasks');
          
          // Dispatch custom event
          const event = new CustomEvent('app-initialized', {
            detail: { taskCount: tasks?.length || 0 }
          });
          window.dispatchEvent(event);
          
          // Call original method
          return originalUpdateTasks.call(this, tasks);
        };
      }
    });
    </script>
</body>
</html>
