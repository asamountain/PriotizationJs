<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Priority Task Manager</title>
    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <!-- Socket.IO and D3 Libraries -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Vue and Vuetify -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.15/dist/vuetify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.15/dist/vuetify.min.css" rel="stylesheet">
    <style>
      /* Split View Layout - Account for app bar */
      .split-view-main {
        padding-top: 56px !important; /* CRITICAL: Space for fixed app bar */
        padding-left: 0 !important;
        padding-right: 0 !important;
        padding-bottom: 0 !important;
        overflow: hidden;
        height: 100vh;
      }
      
      .split-view-container {
        display: flex;
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
      }
      
      .split-view-left {
        flex: 0 0 55%;
        height: 100%;
        overflow: hidden;
        min-width: 300px;
      }
      
      .split-view-right {
        flex: 1;
        height: 100%;
        overflow-y: auto;
        padding: 16px;
        min-width: 300px;
      }
      
      .resize-handle {
        flex: 0 0 6px;
        background: rgba(0, 0, 0, 0.08);
        cursor: col-resize;
        position: relative;
        transition: background 0.2s;
      }
      
      .resize-handle:hover {
        background: rgba(25, 118, 210, 0.3);
      }
      
      .resize-handle:active {
        background: rgba(25, 118, 210, 0.5);
      }
      
      .resize-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 2px;
        height: 40px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
      }
      
      .chart-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 0 !important;
      }
      
      .chart-content {
        flex: 1;
        overflow: visible;
        padding: 0 !important;
        position: relative;
        min-height: 0; /* Allow flexbox to shrink */
      }
      
      #taskChart {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      
      /* Responsive: Stack on smaller screens */
      @media (max-width: 1024px) {
        .split-view-container {
          flex-direction: column;
        }
        
        .split-view-left {
          flex: 0 0 50vh;
          border-right: none;
          border-bottom: 1px solid rgba(0, 0, 0, 0.12);
        }
        
        .split-view-right {
          flex: 1;
        }
      }
      
      :root {
        --golden-ratio: 1.618;
        --base-space: 8px;
        --space-1: var(--base-space); /* 8px */
        --space-2: calc(var(--base-space) * var(--golden-ratio)); /* ~13px */
        --space-3: calc(calc(var(--base-space) * var(--golden-ratio)) * var(--golden-ratio)); /* ~21px */
      }

      /* Task list improvements */
      .v-list-item {
        min-height: 64px !important;
        padding: var(--space-1) var(--space-2) !important;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }
      
      .task-item:hover {
        background-color: rgba(37, 80, 53, 0.04) !important;
      }

      .gap-golden {
        gap: var(--space-2) !important;
      }

      /* --- Simple Hierarchical Tree Structure --- */
      .subtasks-wrapper {
        margin-left: var(--space-3);
        position: relative;
        border-left: 1px solid rgba(0, 0, 0, 0.08);
      }

      /* Junction Toggle Icons */
      .toggle-junction {
        width: 44px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px; /* Tight gap for toggle group */
      }

      /* Checkbox & List Item Tweaks */
      .task-item {
        min-height: 64px !important;
        border-bottom: 1px solid #e8edea !important;
      }

      .task-metrics-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      /* Icon-only button refinements */
      .v-btn--icon.v-btn--size-small {
        width: 32px !important;
        height: 32px !important;
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        .v-list-item {
          padding: var(--space-1) var(--space-1) !important;
        }
        .task-metrics-group {
          gap: var(--space-1) !important;
        }
        .timer-display {
          display: none !important; /* Hide text timer on mobile if needed */
        }
      }

      .text-primary {
        color: #255035 !important;
      }

      .highlighted-task {
        animation: highlight-pulse 1.5s ease-in-out;
      }
      
      @keyframes highlight-pulse {
        0% { background-color: transparent; }
        50% { background-color: rgba(37, 80, 53, 0.1); }
        100% { background-color: transparent; }
      }
      
      .selected-dot {
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
      }
      
      /* Add these styles for better tooltip appearance and positioning */
      .chart-tooltip {
        font-family: 'Roboto', sans-serif;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        word-wrap: break-word;
        overflow: hidden;
      }
      
      .chart-tooltip-header {
        padding: 10px 14px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        font-weight: 500;
      }
      
      .chart-tooltip-body {
        padding: 10px 14px;
      }
      
      /* Make task dots more visible on hover */
      .task-dot:hover {
        stroke: white;
        stroke-width: 2px;
        transition: all 0.2s ease;
      }
      
      /* Selected dot style */
      .selected-dot {
        filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
      }
      
      /* Ensure the chart container has proper overflow handling */
      #taskChart {
        overflow: visible !important;
        position: relative;
      }
      
      /* Add these styles to support the cluster and line-connected tooltips */
      .task-dot.cluster-dot {
        opacity: 0.9;
        transition: all 0.3s ease;
      }
      
      .task-dot.mini-dot {
        opacity: 0.85;
        transition: none;
      }
      
      .task-dot.mini-dot:hover {
        opacity: 0.85;
        transform: none;
      }
      
      .cluster-expansion {
        animation: fade-in 0.3s ease-out;
      }
      
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* Ensure the chart container can show content outside its boundaries */
      .v-card-text {
        overflow: visible !important;
      }
      
      #taskChart {
        overflow: visible !important;
        z-index: 1;
      }
      
      /* Custom style for subtask link chips */
      .subtask-link-chip {
        cursor: pointer !important;
        transition: all 0.2s ease;
      }
      
      .subtask-link-chip:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2) !important;
        background-color: rgba(125, 125, 255, 0.1);
      }
      
      .subtask-link-chip .v-chip__content {
        color: #3f51b5 !important;
      }
      
      .subtask-link-chip .v-chip__content .v-icon {
        color: #651fff !important;
      }
    </style>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Add this notification container just after the body opening tag -->
    <div id="notification-container"></div>
    
    <div id="app">
        <v-app :theme="theme">
            <v-app-bar density="comfortable" elevation="2">
                <v-app-bar-title class="text-primary">Priority Task Manager</v-app-bar-title>
                <v-spacer></v-spacer>
                
                <!-- User Profile / Login -->
                <div v-if="user" class="d-flex align-center me-4">
                    <v-avatar size="32" class="me-2">
                        <v-img :src="user.avatar" :alt="user.name"></v-img>
                    </v-avatar>
                    <span class="text-body-2 me-2 d-none d-sm-inline">{{ user.name }}</span>
                    <v-btn icon size="small" @click="logout" title="Logout" color="primary">
                        <v-icon>mdi-logout</v-icon>
                    </v-btn>
                </div>
                <v-btn v-else-if="authConfig.googleEnabled" color="primary" variant="elevated" prepend-icon="mdi-google" @click="loginWithGoogle" class="me-4">
                    Login
                </v-btn>

                <!-- Analytics Button -->
                <v-btn icon href="/analytics" title="View Analytics & Insights" target="_blank" color="primary">
                    <v-icon>mdi-chart-line</v-icon>
                </v-btn>
                
                <!-- CSV Import Icon Button -->
                <v-btn icon @click="showCsvImportDialog = true" title="Import Tasks from CSV" color="primary">
                    <v-icon>mdi-file-import</v-icon>
                </v-btn>

                <!-- Export Tasks Button (Real Data) -->
                <v-btn icon @click="exportTasks" title="Export Current Tasks to CSV" color="primary">
                    <v-icon>mdi-download</v-icon>
                </v-btn>
                
                <v-btn icon @click="toggleTheme" title="Toggle Theme" color="primary">
                    <v-icon>{{ isDarkTheme ? 'mdi-weather-sunny' : 'mdi-weather-night' }}</v-icon>
                </v-btn>
            </v-app-bar>

            <v-main class="split-view-main">
                <!-- Split View Container -->
                <div class="split-view-container" ref="splitContainer">
                    <!-- LEFT SIDE: Chart (always full height) -->
                    <div class="split-view-left" ref="leftPanel" :style="{ flex: `0 0 ${leftPanelWidth}%` }">
                        <v-card class="chart-card" elevation="3">
                            <v-card-title class="text-h6 d-flex align-center pa-3">
                                <v-icon class="me-2" color="primary">mdi-chart-scatter-plot</v-icon>
                                Eisenhower Matrix
                                <v-spacer></v-spacer>
                                <v-chip color="primary" size="small">{{ activeTasks.length }}</v-chip>
                            </v-card-title>
                            <v-card-text class="chart-content">
                                <div id="taskChart" :style="chartStyle"></div>
                            </v-card-text>
                        </v-card>
                    </div>

                    <!-- RESIZE HANDLE -->
                    <div 
                        class="resize-handle" 
                        @mousedown="startResize"
                        title="Drag to resize"
                    ></div>

                    <!-- RIGHT SIDE: Task List (scrollable) -->
                    <div class="split-view-right" ref="rightPanel">

                        <!-- Active Tasks Section -->
                        <v-card class="mb-4" elevation="3">
                        <v-card-title 
                            class="text-h5 d-flex align-center"
                            @dragover.prevent="handleDragOver"
                            @drop="handleDropOnRoot"
                            style="cursor: default;"
                            title="Drop tasks here to make them root tasks"
                        >
                            Active Tasks
                            <v-spacer></v-spacer>
                            <v-chip color="primary" size="small">{{ activeTasks.length }}</v-chip>
                            <v-btn 
                                variant="text" 
                                icon 
                                @click="toggleCompletedSubtasks"
                                class="ms-2"
                                title="Toggle completed subtasks"
                                color="primary"
                            >
                                <v-icon>
                                    {{ showCompletedSubtasks ? 'mdi-eye-off' : 'mdi-eye' }}
                                </v-icon>
                            </v-btn>
                            <v-btn 
                                variant="text" 
                                icon 
                                @click="toggleNotSureTasks"
                                class="ms-2"
                                :color="showNotSureTasks ? 'warning' : 'primary'"
                                title="Toggle 'Not Sure' tasks"
                            >
                                <v-icon>
                                    {{ showNotSureTasks ? 'mdi-help-circle' : 'mdi-help-circle-outline' }}
                                </v-icon>
                            </v-btn>
                        </v-card-title>
                        <v-card-text>
                            <!-- Sort Dropdown -->
                            <div class="mb-2 px-2">
                                <v-select
                                    v-model="taskSortBy"
                                    :items="taskSortOptions"
                                    label="Sort by"
                                    variant="underlined"
                                    density="compact"
                                    prepend-inner-icon="mdi-sort"
                                    hide-details
                                    class="minimal-select"
                                ></v-select>
                            </div>
                            
                            <v-list v-if="activeTasks.length > 0">
                                <task-node
                                    v-for="task in sortedActiveTasks"
                                    :key="task.id"
                                    :task="task"
                                    :depth="0"
                                    :tasks="tasks"
                                    :expanded-tasks="expandedTasks"
                                    :show-completed-subtasks="showCompletedSubtasks"
                                ></task-node>
                            </v-list>
                            
                            <v-sheet v-else class="pa-4 text-center">
                                <v-icon size="large" color="grey">mdi-playlist-check</v-icon>
                                <div class="text-body-1 mt-2">No active tasks. Add a task to get started!</div>
                            </v-sheet>
                            
                            <!-- Empty drop area -->
                            <v-sheet
                                id="empty-drop-area"
                                ref="emptyDropArea"
                                class="mt-4 pa-6 text-center bg-grey-lighten-4 rounded"
                                border
                                @dragover="handleDragOver"
                                @dragleave="handleDragLeave"
                                @drop="handleDropOnRoot"
                                :class="{ 'drag-over': draggedTask }"
                            >
                                <v-icon color="grey" class="mb-2">mdi-drag</v-icon>
                                <div class="text-body-2 text-grey">Drop tasks here to move to root level</div>
                            </v-sheet>
                        </v-card-text>
                    </v-card>

                        <!-- Completed Tasks Section -->
                        <v-card v-if="hasCompletedTasks" class="mb-4" elevation="3">
                        <v-card-title 
                            class="text-h5 d-flex align-center" 
                            @click="toggleTaskSection('completed')"
                            style="cursor: pointer;"
                        >
                            <v-icon color="success" class="me-2">mdi-check-circle</v-icon>
                            Completed Tasks
                            <v-spacer></v-spacer>
                            <v-chip color="success" size="small">{{ completedTasks.length }}</v-chip>
                            <v-icon>{{ taskSectionOpen.completed ? 'mdi-chevron-up' : 'mdi-chevron-down' }}</v-icon>
                        </v-card-title>
                        
                        <v-expand-transition>
                            <div v-show="taskSectionOpen.completed">
                                <v-list>
                            <template v-for="task in completedTasks" :key="task.id">
                                        <!-- Completed Parent Task -->
                                        <v-list-item
                                            :value="task.id"
                                            @click="selectTask(task)"
                                            @dblclick="showAddSubtaskForm(task.id)"
                                    :data-task-id="task.id"
                                            style="cursor: pointer;" 
                                            class="task completed-task"
                                        >
                                            <template v-slot:prepend>
                                                <v-checkbox 
                                                    :model-value="true" 
                                                    @change="toggleTaskDone(task)"
                                                    color="success"
                                                    hide-details
                                                    @click.stop
                                                ></v-checkbox>
                                            </template>

                                            <v-list-item-title class="text-decoration-line-through">
                                                {{ task.name }}
                                            </v-list-item-title>

                                            <v-list-item-subtitle>
                                                <div class="d-flex align-center">
                                                    <span class="text-caption text-medium-emphasis me-2" v-if="task.completed_at">
                                                        Completed: {{ formatDate(task.completed_at) }}
                                                    </span>
                                                    <v-btn
                                                        v-if="task.link"
                                                        size="x-small"
                                                        :href="task.link" 
                                                        target="_blank"
                                                        color="primary"
                                                        variant="text"
                                                        class="px-0 min-width-0 me-2"
                                                        @click.stop
                                                    >
                                                        <v-icon start size="x-small">mdi-link</v-icon>
                                                        Link
                                                    </v-btn>
                                                </div>
                                            </v-list-item-subtitle>

                                            <template v-slot:append>
                                                <v-btn
                                                    icon="mdi-delete"
                                                    variant="text"
                                                    size="small"
                                                    @click.stop="deleteTask(task.id, task.name)"
                                                    color="error"
                                                    title="Delete task"
                                                ></v-btn>
                                            </template>
                                        </v-list-item>
                                        
                                        <v-divider></v-divider>
                                    </template>
                                </v-list>
                                            </div>
                        </v-expand-transition>
                        </v-card>
                    </div>
                    <!-- End Right Side -->
                </div>
                <!-- End Split View Container -->
            </v-main>

            <!-- Subtask Modal Dialog -->
            <v-dialog v-model="showSubtaskModal" max-width="500px">
                <v-card>
                    <v-card-title class="text-h5">Add Subtask</v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="addSubtask">
                            <v-text-field
                                v-model="newSubtask.name"
                                label="Subtask Name"
                                required
                                variant="outlined"
                            ></v-text-field>
                            
                            <v-text-field
                                v-model="newSubtask.link"
                                label="Link (optional)"
                                variant="outlined"
                                placeholder="Add a URL (http://example.com)"
                            ></v-text-field>
                            
                            <v-subheader>Importance (1-10)</v-subheader>
                            <v-slider
                                v-model="newSubtask.importance"
                                min="1"
                                max="10"
                                step="1"
                                show-ticks="always"
                                color="primary"
                                thumb-label
                            ></v-slider>
                            
                            <v-subheader>Urgency (1-10)</v-subheader>
                            <v-slider
                                v-model="newSubtask.urgency"
                                min="1"
                                max="10"
                                step="1"
                                show-ticks="always"
                                color="secondary"
                                thumb-label
                            ></v-slider>
                            
                            <v-date-picker
                                v-model="newSubtask.due_date"
                                label="Due Date (Optional)"
                                variant="outlined"
                            ></v-date-picker>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="closeSubtaskModal">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="addSubtask">Add Subtask</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Edit Subtask Dialog -->
            <v-dialog v-model="showEditForm" max-width="500px">
                <v-card>
                    <v-card-title class="text-h5">Edit Subtask</v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="saveSubtaskEdit">
                            <v-text-field
                                v-model="editingSubtask.name"
                                label="Subtask Name"
                                required
                                variant="outlined"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ editingSubtask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="editingSubtask.icon = icon"
                                                    :color="editingSubtask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>
                            
                            <v-text-field
                                v-model="editingSubtask.link"
                                label="Link (optional)"
                                variant="outlined"
                                placeholder="Add a URL (http://example.com)"
                            ></v-text-field>
                            
                            <div class="d-flex align-center justify-space-between mb-1 mt-2">
                                <span class="text-subtitle-2">Importance: {{ editingSubtask.importance }}</span>
                                <v-chip :color="getPriorityColor(editingSubtask.importance)" size="x-small" variant="flat">
                                    {{ editingSubtask.importance >= 8 ? 'CRITICAL' : (editingSubtask.importance >= 5 ? 'HIGH' : 'LOW') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingSubtask.importance"
                                min="1"
                                max="10"
                                step="1"
                                :color="getPriorityColor(editingSubtask.importance)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-star-outline</v-icon>
                                </template>
                            </v-slider>
                            
                            <div class="d-flex align-center justify-space-between mb-1">
                                <span class="text-subtitle-2">Urgency: {{ editingSubtask.urgency }}</span>
                                <v-chip :color="getPriorityColor(editingSubtask.urgency)" size="x-small" variant="flat">
                                    {{ editingSubtask.urgency >= 8 ? 'IMMEDIATE' : (editingSubtask.urgency >= 5 ? 'SOON' : 'LATER') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingSubtask.urgency"
                                min="1"
                                max="10"
                                step="1"
                                :color="getPriorityColor(editingSubtask.urgency)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-clock-outline</v-icon>
                                </template>
                            </v-slider>
                            
                            <v-select
                                v-model="editingSubtask.parent_id"
                                :items="possibleParents"
                                item-title="name"
                                item-value="id"
                                label="Parent Task"
                                variant="outlined"
                            ></v-select>
                            
                            <v-date-picker
                                v-model="editingSubtask.due_date"
                                label="Due Date (Optional)"
                                variant="outlined"
                            ></v-date-picker>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="cancelEdit">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="saveSubtaskEdit">Save</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Edit Task Dialog -->
            <v-dialog v-model="showTaskEditForm" max-width="500px">
                <v-card>
                    <v-card-title class="text-h5">Edit Task</v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="saveTaskEdit">
                            <v-text-field
                                v-model="editingTask.name"
                                label="Task Name"
                                required
                                variant="outlined"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ editingTask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="editingTask.icon = icon"
                                                    :color="editingTask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>
                            
                            <v-text-field
                                v-model="editingTask.link"
                                label="Link (optional)"
                                variant="outlined"
                                placeholder="Add a URL (http://example.com)"
                            ></v-text-field>
                            
                            <div class="d-flex align-center justify-space-between mb-1 mt-2">
                                <span class="text-subtitle-2">Importance: {{ editingTask.importance }}</span>
                                <v-chip :color="getPriorityColor(editingTask.importance)" size="x-small" variant="flat">
                                    {{ editingTask.importance >= 8 ? 'CRITICAL' : (editingTask.importance >= 5 ? 'HIGH' : 'LOW') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingTask.importance"
                                min="1"
                                max="10"
                                step="1"
                                :color="getPriorityColor(editingTask.importance)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-star-outline</v-icon>
                                </template>
                            </v-slider>
                            
                            <div class="d-flex align-center justify-space-between mb-1">
                                <span class="text-subtitle-2">Urgency: {{ editingTask.urgency }}</span>
                                <v-chip :color="getPriorityColor(editingTask.urgency)" size="x-small" variant="flat">
                                    {{ editingTask.urgency >= 8 ? 'IMMEDIATE' : (editingTask.urgency >= 5 ? 'SOON' : 'LATER') }}
                                </v-chip>
                            </div>
                            <v-slider
                                v-model="editingTask.urgency"
                                min="1"
                                max="10"
                                step="1"
                                :color="getPriorityColor(editingTask.urgency)"
                                track-color="grey-lighten-3"
                                hide-details
                                class="mb-4"
                            >
                                <template v-slot:prepend>
                                    <v-icon size="small" color="grey">mdi-clock-outline</v-icon>
                                </template>
                            </v-slider>
                            
                            <v-date-picker
                                v-model="editingTask.due_date"
                                label="Due Date (Optional)"
                                variant="outlined"
                            ></v-date-picker>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="cancelTaskEdit">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="saveTaskEdit">Save</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Notes Dialog -->
            <v-dialog v-model="showNotesDialog" max-width="600px" persistent scrollable>
                <v-card v-if="currentTask" style="min-height: 400px">
                    <v-card-title class="text-h5 bg-primary text-white">
                        {{ currentTask.notes ? 'Edit Notes: ' : 'Add Notes: ' }} {{ currentTask.name }}
                    </v-card-title>
                    <v-card-text class="pa-4">
                        <!-- Stable key for proper Vue reactivity -->
                        <v-textarea
                            :key="`notes-${noteTaskId}`"
                            v-model="editingNotes"
                            label="Task Notes"
                            variant="outlined"
                            rows="8"
                            counter
                            auto-grow
                            placeholder="Add your notes here..."
                        ></v-textarea>
                        
                        <!-- Add a debug display to see what's happening -->
                        <div v-if="currentTask" class="mt-3 text-caption">
                            Task ID: {{ currentTask.id }} <br>
                            Note Length: {{ editingNotes ? editingNotes.length : 0 }} characters
                        </div>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="grey" variant="text" @click="closeNotesDialog">Cancel</v-btn>
                        <v-btn color="primary" variant="elevated" @click="saveTaskNotes">
                            Save Notes
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- CSV Import Dialog -->
            <v-dialog v-model="showCsvImportDialog" max-width="600px">
                <v-card>
                    <v-card-title class="text-h5 d-flex align-center">
                        <v-icon class="me-2" color="success">mdi-file-import</v-icon>
                        Import Tasks from CSV
                    </v-card-title>
                    <v-card-text>
                        <v-file-input
                            v-model="csvFile"
                            label="Select CSV file"
                            accept=".csv"
                            prepend-icon="mdi-file-delimited"
                            variant="outlined"
                            clearable
                            class="mb-3"
                        ></v-file-input>
                        
                        <!-- Import Results -->
                        <v-alert
                            v-if="csvImportResult"
                            :type="csvImportResult.success ? 'success' : 'error'"
                            closable
                            @click:close="csvImportResult = null"
                        >
                            <div v-if="csvImportResult.success">
                                Successfully imported {{ csvImportResult.details.imported }} tasks
                                <span v-if="csvImportResult.details.errors && csvImportResult.details.errors.length > 0">
                                    ({{ csvImportResult.details.errors.length }} errors)
                                </span>
                            </div>
                            <div v-else>
                                Failed to import CSV: {{ csvImportResult.error }}
                            </div>
                            
                            <div v-if="csvImportResult.details && csvImportResult.details.errors && csvImportResult.details.errors.length > 0" class="mt-2">
                                <strong>Errors:</strong>
                                <ul class="ml-4">
                                    <li v-for="error in csvImportResult.details.errors" :key="error.row">
                                        Row {{ error.row }}: {{ error.error }}
                                    </li>
                                </ul>
                            </div>
                        </v-alert>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn
                            color="grey"
                            variant="text"
                            @click="showCsvImportDialog = false"
                        >
                            Cancel
                        </v-btn>
                        <v-btn
                            color="success"
                            variant="elevated"
                            @click="importCSV"
                            :loading="csvImporting"
                            :disabled="!csvFile || csvImporting"
                        >
                            <v-icon start>mdi-upload</v-icon>
                            Import CSV
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Quick Add Task Modal -->
            <v-dialog v-model="showQuickAddModal" max-width="600px">
                <v-card>
                    <v-card-title class="text-h5 d-flex align-center">
                        <v-icon class="me-2" color="primary">mdi-plus-circle-outline</v-icon>
                        Quick Add Task
                    </v-card-title>
                    <v-card-text>
                        <v-form @submit.prevent="submitQuickTask">
                            <v-text-field
                                v-model="quickAddTask.name"
                                label="Task Name *"
                                placeholder="Enter task name..."
                                variant="outlined"
                                required
                                autofocus
                                class="mb-3"
                            >
                                <template v-slot:prepend-inner>
                                    <v-menu location="bottom start">
                                        <template v-slot:activator="{ props }">
                                            <v-btn icon size="small" variant="text" v-bind="props" class="me-2">
                                                <v-icon>{{ quickAddTask.icon || 'mdi-checkbox-blank-circle-outline' }}</v-icon>
                                            </v-btn>
                                        </template>
                                        <v-card max-width="300" class="pa-2">
                                            <div class="d-flex flex-wrap gap-1 justify-center">
                                                <v-btn
                                                    v-for="icon in availableIcons"
                                                    :key="icon"
                                                    icon
                                                    size="small"
                                                    variant="text"
                                                    @click="quickAddTask.icon = icon"
                                                    :color="quickAddTask.icon === icon ? 'primary' : ''"
                                                >
                                                    <v-icon>{{ icon }}</v-icon>
                                                </v-btn>
                                            </div>
                                        </v-card>
                                    </v-menu>
                                </template>
                            </v-text-field>

                            <v-row class="mb-3">
                                <v-col cols="12">
                                    <div class="d-flex align-center justify-space-between mb-1">
                                        <span class="text-subtitle-2">Importance: {{ quickAddTask.importance }}</span>
                                        <v-chip :color="getPriorityColor(quickAddTask.importance)" size="x-small" variant="flat">
                                            {{ quickAddTask.importance >= 8 ? 'CRITICAL' : (quickAddTask.importance >= 5 ? 'HIGH' : 'LOW') }}
                                        </v-chip>
                                    </div>
                                    <v-slider
                                        v-model="quickAddTask.importance"
                                        min="1"
                                        max="10"
                                        step="1"
                                        :color="getPriorityColor(quickAddTask.importance)"
                                        track-color="grey-lighten-3"
                                        hide-details
                                    >
                                        <template v-slot:prepend>
                                            <v-icon size="small" color="grey">mdi-star-outline</v-icon>
                                        </template>
                                        <template v-slot:append>
                                            <v-icon size="small" :color="getPriorityColor(quickAddTask.importance)">mdi-star</v-icon>
                                        </template>
                                    </v-slider>
                                </v-col>
                                
                                <v-col cols="12" class="mt-2">
                                    <div class="d-flex align-center justify-space-between mb-1">
                                        <span class="text-subtitle-2">Urgency: {{ quickAddTask.urgency }}</span>
                                        <v-chip :color="getPriorityColor(quickAddTask.urgency)" size="x-small" variant="flat">
                                            {{ quickAddTask.urgency >= 8 ? 'IMMEDIATE' : (quickAddTask.urgency >= 5 ? 'SOON' : 'LATER') }}
                                        </v-chip>
                                    </div>
                                    <v-slider
                                        v-model="quickAddTask.urgency"
                                        min="1"
                                        max="10"
                                        step="1"
                                        :color="getPriorityColor(quickAddTask.urgency)"
                                        track-color="grey-lighten-3"
                                        hide-details
                                    >
                                        <template v-slot:prepend>
                                            <v-icon size="small" color="grey">mdi-clock-outline</v-icon>
                                        </template>
                                        <template v-slot:append>
                                            <v-icon size="small" :color="getPriorityColor(quickAddTask.urgency)">mdi-clock-fast</v-icon>
                                        </template>
                                    </v-slider>
                                </v-col>
                            </v-row>

                            <v-text-field
                                v-model="quickAddTask.link"
                                label="Link (optional)"
                                placeholder="https://..."
                                variant="outlined"
                                class="mb-3"
                            ></v-text-field>

                            <v-textarea
                                v-model="quickAddTask.notes"
                                label="Notes (optional)"
                                placeholder="Additional details..."
                                variant="outlined"
                                rows="3"
                            ></v-textarea>
                        </v-form>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn
                            color="grey"
                            variant="text"
                            @click="closeQuickAddModal"
                        >
                            Cancel
                        </v-btn>
                        <v-btn
                            color="primary"
                            variant="elevated"
                            @click="submitQuickTask"
                        >
                            Add Task
                            <v-icon end>mdi-check</v-icon>
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Pomodoro Break Dialog -->
            <v-dialog v-model="showBreakDialog" max-width="500px" persistent>
                <v-card>
                    <v-card-title class="text-h5 bg-success text-white">
                        üçÖ Pomodoro Complete!
                    </v-card-title>
                    <v-card-text class="pt-6">
                        <div class="text-center mb-4">
                            <v-icon size="64" color="success">mdi-check-circle</v-icon>
                        </div>
                        <p class="text-h6 text-center mb-4">
                            Great job! You completed a 25-minute focus session.
                        </p>
                        <p class="text-center mb-2" v-if="breakTask">
                            <strong>Task:</strong> {{ breakTask.name }}
                        </p>
                        <p class="text-center mb-4" v-if="breakTask">
                            <v-chip color="primary" variant="flat">
                                üçÖ {{ breakTask.pomodoro_count }} Pomodoros completed
                            </v-chip>
                        </p>
                        <v-divider class="my-4"></v-divider>
                        <p class="text-center text-h6 mb-2">
                            Time for a {{ breakType === 'long' ? '15' : '5' }}-minute break!
                        </p>
                        <p class="text-center text-body-2 text-grey">
                            {{ breakType === 'long' ? 'üåü Long break - You earned it!' : '‚òï Short break - Rest and recharge' }}
                        </p>
                    </v-card-text>
                    <v-card-actions class="px-6 pb-4">
                        <v-btn text @click="skipBreak" color="grey">
                            Skip Break
                        </v-btn>
                        <v-spacer></v-spacer>
                        <v-btn color="success" variant="flat" size="large" @click="startBreak">
                            <v-icon start>mdi-coffee</v-icon>
                            Start {{ breakType === 'long' ? '15' : '5' }}-Min Break
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Break Timer Indicator (when break is active) -->
            <v-snackbar
                :model-value="breakTimeRemaining > 0"
                :timeout="-1"
                location="top"
                color="info"
            >
                <div class="d-flex align-center">
                    <v-icon start>mdi-coffee</v-icon>
                    <span class="text-h6 mr-2">Break Time:</span>
                    <span class="text-h5 font-weight-bold">{{ formatTime(breakTimeRemaining) }}</span>
                    <v-spacer></v-spacer>
                    <v-btn icon size="small" @click="endBreak">
                        <v-icon>mdi-close</v-icon>
                    </v-btn>
                </div>
            </v-snackbar>

            <!-- Snackbar for notifications -->
            <v-snackbar
                v-model="snackbar.show"
                :color="snackbar.color"
                :timeout="snackbar.timeout"
            >
                {{ snackbar.text }}
                <template v-slot:actions>
                    <v-btn
                        color="white"
                        icon="mdi-close"
                        variant="text"
                        @click="snackbar.show = false"
                    ></v-btn>
                </template>
            </v-snackbar>
        </v-app>
    </div>

    <!-- Updated Scripts -->
    <script src="modules/chartVisualization.js" type="module"></script>
    <script src="app.js" type="module"></script>

    <!-- Add this right after your body tag -->
    <script>
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded - Vuetify version:', typeof Vuetify);
      
      // Add listener to track app initialization
      window.addEventListener('app-initialized', function(e) {
        console.log('App initialized with tasks:', e.detail.taskCount);
      });
      
      // Debug socket events
      document.addEventListener('socket-event', function(e) {
        console.log('Socket event:', e.detail.event, 'with data:', e.detail.data);
      });
    });
    </script>

    <!-- Replace with this Vue 3 compatible version -->
    <script>
    window.addEventListener('app-mounted', function() {
      // Wait for app to be available in the window object
      if (window.app && typeof window.app.updateTasks === 'function') {
        const originalUpdateTasks = window.app.updateTasks;
        
        window.app.updateTasks = function(tasks) {
          console.log('updateTasks called with:', tasks?.length || 0, 'tasks');
          
          // Dispatch custom event
          const event = new CustomEvent('app-initialized', {
            detail: { taskCount: tasks?.length || 0 }
          });
          window.dispatchEvent(event);
          
          // Call original method
          return originalUpdateTasks.call(this, tasks);
        };
      }
    });
    </script>
</body>
</html>
